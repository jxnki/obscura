<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Routify Dashboard - Complete Travel Solution</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root {
      --primary-blue: #0077b6;
      --secondary-blue: #00b4d8;
      --success-green: #28a745;
      --warning-orange: #ff6600;
      --danger-red: #f56565;
      --light-bg: #f8faff;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    body {
      background: var(--light-bg);
      font-family: 'Poppins', sans-serif;
    }

    /* Dashboard Layout */
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    /* Dashboard Cards */
    .dashboard-card {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      margin-bottom: 1.5rem;
    }

    .dashboard-card h3 {
      color: var(--primary-blue);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Header Enhancement */
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
      color: white;
      padding: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 0 0 20px 20px;
      margin-bottom: 2rem;
    }

    .user-welcome h2 {
      margin: 0 0 0.5rem 0;
    }

    .user-stats {
      display: flex;
      gap: 2rem;
    }

    .stat-item {
      text-align: center;
      background: rgba(255,255,255,0.1);
      padding: 1rem;
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      background: white;
      border-radius: 15px;
      padding: 0.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
    }

    .tab-btn {
      flex: 1;
      padding: 1rem;
      background: transparent;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .tab-btn.active {
      background: var(--primary-blue);
      color: white;
      box-shadow: 0 2px 8px rgba(0,119,182,0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Map Styling */
    #map {
      height: 400px;
      border-radius: 10px;
      margin: 1rem 0;
    }

    /* Form Styling */
    .input-group {
      position: relative;
      margin-bottom: 1rem;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.1);
    }

    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 119, 182, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success-green), #20c997);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(40, 167, 69, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger-red), #e53e3e);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(245, 101, 101, 0.3);
    }

    /* Location Sharing Controls */
    .location-sharing-controls {
      margin: 1rem 0;
    }

    .location-control-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .location-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .location-info h4 {
      margin: 0 0 0.5rem 0;
      color: var(--primary-blue);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .location-info p {
      margin: 0;
      color: #666;
      font-size: 0.9rem;
    }

    .location-actions {
      display: flex;
      gap: 0.5rem;
    }

    .location-details {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #dee2e6;
    }

    .location-status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      color: var(--success-green);
      font-weight: 500;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.online {
      background: var(--success-green);
      box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
    }

    .location-info-text {
      color: #666;
      font-size: 0.85rem;
    }

    /* Match Cards */
    .matches-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
    }

    .match-card {
      background: white;
      border: 1px solid #e1e5e9;
      border-radius: 12px;
      padding: 1rem;
      transition: all 0.3s ease;
    }

    .match-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .match-similarity {
      background: var(--success-green);
      color: white;
      padding: 4px 8px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .match-similarity.high-match {
      background: var(--success-green);
    }

    .match-similarity.low-match {
      background: #6c757d;
    }

    .match-similarity.connected-match {
      background: var(--warning-orange);
    }

    /* Live Users */
    .live-users {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .live-user {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .live-user i.fa-circle {
      color: var(--success-green);
    }

    /* Location Toggle */
    .location-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .toggle-checkbox {
      position: relative;
      width: 50px;
      height: 25px;
      -webkit-appearance: none;
      appearance: none;
      background: #ccc;
      border-radius: 25px;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    .toggle-checkbox:checked {
      background: var(--success-green);
    }

    .toggle-checkbox::before {
      content: '';
      position: absolute;
      width: 21px;
      height: 21px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.3s;
    }

    .toggle-checkbox:checked::before {
      transform: translateX(25px);
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .quick-action-card {
      background: white;
      border: 2px solid #e1e5e9;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .quick-action-card:hover {
      border-color: var(--primary-blue);
      transform: translateY(-2px);
    }

    .quick-action-card i {
      font-size: 2rem;
      color: var(--primary-blue);
      margin-bottom: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 1fr;
        padding: 1rem;
      }

      .input-row {
        grid-template-columns: 1fr;
      }

      .user-stats {
        flex-direction: column;
        gap: 1rem;
      }
    }

    /* Loading and Modals */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .loading-spinner {
      text-align: center;
      color: var(--primary-blue);
    }

    .loading-spinner i {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      z-index: 1001;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: var(--success-green);
    }

    .notification.error {
      background: var(--danger-red);
    }

    .notification.info {
      background: var(--primary-blue);
    }
    .route-buttons {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  align-items: center;
  justify-content: center;
  margin: 1rem 0;
}

.wide-btn {
  width: 100%;
  max-width: 400px;
  padding: 1rem 2rem;
  font-size: 1.1rem;
  justify-content: center;
}

  </style>
</head>
<body>
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <div class="user-welcome">
      <img src="logo.png" alt="Routify Logo" class="logo-img" />
      <h2 id="welcomeUser">Welcome back!</h2>
      <p id="userSubtext">Manage your events and connect with others!</p>
    </div>

    <div>
      <button onclick="logout()" class="btn-white">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="full-width">
    <div class="tab-navigation">
      <button class="tab-btn active" onclick="switchTab('my-events')">
        <i class="fas fa-route"></i> RouteHub
      </button>
      <button class="tab-btn" onclick="window.location.href='index3.html'">
        <i class="fas fa-users-plus"></i> Create Event / Join Event
      </button>
    </div>
  </div>

  <!-- Main Dashboard Container -->
 <!-- Route Planning Section -->
<div class="dashboard-card full-width">

  <div class="route-buttons">
    <button onclick="window.location.href='route.html'" class="btn-primary wide-btn">
      <i class="fas fa-route"></i> Find Route
    </button>

    <button onclick="window.location.href='friends.html'" class="btn-primary wide-btn">
      <i class="fas fa-user-friends"></i> Connect with Friends
    </button>

    <button onclick="window.location.href='chatbot.html'" class="btn-primary wide-btn">
      <i class="fas fa-robot"></i> RoutiBot
    </button>
  </div>

  <div id="routeInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
    <h4>Route Information</h4>
    <div id="routeDetails"></div>
  </div>

</div>


      <!-- User Profile Section -->
      <div class="dashboard-card profile-card">
        <div class="profile-header">
          <div class="profile-cover">
            <div class="profile-avatar-container">
              <div class="profile-avatar">
                <i class="fas fa-user-circle"></i>
                <div class="profile-status-indicator online"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="profile-content">
          <div class="profile-main-info">
            <h2 id="profileUsername">Username</h2>
            <p class="profile-handle">@<span id="profileHandle">username</span></p>
            <p id="profileEmail" class="profile-email">Loading...</p>
            
            <div class="profile-badges">
              <span id="accountTypeBadge" class="profile-badge">Standard</span>
              <span id="verificationBadge" class="profile-badge verification">Not Verified</span>
            </div>
          </div>
          
          <div class="profile-stats-row">
            <div class="profile-stat">
              <div class="stat-number" id="profileEvents">0</div>
              <div class="stat-label">Events</div>
            </div>
            <div class="profile-stat">
              <div class="stat-number" id="profileFollowers">0</div>
              <div class="stat-label">Followers</div>
            </div>
            <div class="profile-stat">
              <div class="stat-number" id="profileFollowing">0</div>
              <div class="stat-label">Following</div>
            </div>
          </div>
          
          <div class="profile-bio">
            <p id="profileBio">Event organizer & community builder 🎉</p>
          </div>
          
          <div class="profile-meta-info">
            <div class="meta-item">
              <i class="fas fa-calendar-alt"></i>
              <span>Joined <span id="memberSince">Loading...</span></span>
            </div>
            <div class="meta-item">
              <i class="fas fa-map-marker-alt"></i>
              <span id="profileLocation">Location not set</span>
            </div>
          </div>
        
          
          <div class="profile-actions">
            <button class="btn-profile-primary" onclick="editProfile()">
              <i class="fas fa-edit"></i> Edit Profile
            </button>
            <button class="btn-profile-secondary" onclick="shareProfile()">
              <i class="fas fa-share"></i> Share Profile
            </button>
          </div>
        </div>
      </div>

      <!-- Search Other Users -->
      <div class="dashboard-card full-width">
        <h3><i class="fas fa-users"></i> Find Other Users</h3>
        <div class="user-search-section">
          <div class="input-group">
            <i class="fas fa-search"></i>
            <input type="text" id="userSearch" placeholder="Search users by username or email..." />
          </div>
          <button onclick="searchUsers()" class="btn-primary" style="margin-top: 1rem;">
            <i class="fas fa-search"></i> Search Users
          </button>
        </div>
        
        <div id="userSearchResults" class="user-results-grid" style="display: none;">
          <h4>Search Results</h4>
          <div id="userResultsList"></div>
        </div>
      </div>

      <!-- My Routes List -->
      <div class="dashboard-card full-width">
        <h3><i class="fas fa-map-marked-alt"></i> My Saved Routes</h3>
        <div id="myEventsContainer">
          <div id="noMyEvents" style="text-align: center; padding: 2rem; color: #666;">
            <i class="fas fa-route" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>You haven't saved any routes yet!</p>
            <p style="font-size: 0.9rem; color: #999;">Start planning routes using the map above</p>
          </div>
          <div id="myEventsList" class="events-grid"></div>
        </div>
      </div>
    </div>


    <!-- Join Event Tab -->
    <div id="join-event" class="tab-content">
      <div class="dashboard-card full-width">
        <h3><i class="fas fa-ticket-alt"></i> Join Event by Code</h3>
        
        <!-- Join by Code -->
        <div class="join-by-code-section" style="margin-bottom: 2rem;">
          <div class="input-group">
            <i class="fas fa-key"></i>
            <input type="text" id="eventCodeInput" placeholder="Enter event code (e.g., EVNT-ABC123)" style="text-transform: uppercase;" />
          </div>
          
          <button onclick="joinEventByCode()" class="btn-primary" style="margin-top: 1rem; width: 100%;">
            <i class="fas fa-sign-in-alt"></i> Join Event
          </button>
          
          <div id="joinCodeResult" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px;">
            <!-- Result will be displayed here -->
          </div>
        </div>
      </div>

      <div class="dashboard-card full-width">
        <h3><i class="fas fa-search"></i> Find Events to Join</h3>
        
        <!-- Search Events -->
        <div class="event-search-section">
          <div class="input-group">
            <i class="fas fa-search"></i>
            <input type="text" id="eventSearch" placeholder="Search events by name, location, or category..." />
          </div>
          
          <div class="input-row" style="margin-top: 1rem;">
            <div class="input-group">
              <i class="fas fa-map-marker-alt"></i>
              <input type="text" id="locationFilter" placeholder="Filter by location" />
            </div>
            
            <div class="input-group">
              <i class="fas fa-tags"></i>
              <select id="categoryFilter">
                <option value="">All Categories</option>
                <option value="sports">🏃 Sports</option>
                <option value="music">🎵 Music</option>
                <option value="food">🍽️ Food</option>
                <option value="travel">✈️ Travel</option>
                <option value="business">💼 Business</option>
                <option value="education">📚 Education</option>
                <option value="social">👥 Social</option>
              </select>
            </div>
          </div>
          
          <button onclick="searchEvents()" class="btn-primary" style="margin-top: 1rem;">
            <i class="fas fa-search"></i> Search Events
          </button>
        </div>
      </div>

      <!-- Available Events -->
      <div class="dashboard-card full-width">
        <h3><i class="fas fa-calendar-alt"></i> Available Events</h3>
        <div id="availableEventsContainer">
          <div id="noAvailableEvents" style="text-align: center; padding: 2rem; color: #666;">
            <i class="fas fa-calendar" style="font-size: 3rem; margin-bottom: 1rem;"></i>
            <p>No events available at the moment.</p>
            <p style="font-size: 0.9rem; color: #999;">Check back later or create your own event!</p>
          </div>
          <div id="availableEventsList" class="events-grid"></div>
        </div>
      </div>
    </div>

    <!-- Create Event Tab -->
<div id="create-event" class="tab-content">
  <div class="dashboard-card full-width">
    <h3><i class="fas fa-plus-circle"></i> Create New Event</h3>
    
    <form id="createEventForm">
      <div class="input-group">
        <i class="fas fa-heading"></i>
        <input type="text" id="eventTitle" placeholder="Event Title" required />
      </div>

      <div class="input-group">
        <i class="fas fa-align-left"></i>
        <textarea id="eventDescription" placeholder="Event Description" rows="4" style="padding: 12px 15px 12px 45px; resize: vertical; font-family: 'Poppins', sans-serif;"></textarea>
      </div>

      <div class="input-row">
        <div class="input-group">
          <i class="fas fa-calendar"></i>
          <input type="date" id="eventDate" required />
        </div>

        <div class="input-group">
          <i class="fas fa-clock"></i>
          <input type="time" id="eventTime" required />
        </div>
      </div>

      <div class="input-row">
        <div class="input-group">
          <i class="fas fa-map-marker-alt"></i>
          <input type="text" id="eventLocation" placeholder="Event Location" required />
        </div>

        <div class="input-group">
          <i class="fas fa-users"></i>
          <input type="number" id="maxParticipants" placeholder="Max Participants" min="1" />
        </div>
      </div>

      <div class="input-row">
        <div class="input-group">
          <i class="fas fa-tags"></i>
          <select id="eventCategory" required>
            <option value="" disabled selected>Select Category</option>
            <option value="sports">🏃 Sports</option>
            <option value="music">🎵 Music</option>
            <option value="food">🍽️ Food</option>
            <option value="travel">✈️ Travel</option>
            <option value="business">💼 Business</option>
            <option value="education">📚 Education</option>
            <option value="social">👥 Social</option>
          </select>
        </div>

        <div class="input-group">
          <i class="fas fa-dollar-sign"></i>
          <input type="number" id="eventPrice" placeholder="Price (₹)" min="0" step="0.01" />
        </div>
      </div>

      <div class="checkbox-group" style="margin: 1rem 0;">
        <label style="display: flex; align-items: center; gap: 0.5rem;">
          <input type="checkbox" id="isPublicEvent" checked />
          <span>Make this event public</span>
        </label>
      </div>

      <button type="submit" class="btn-primary" style="width: 100%;">
        <i class="fas fa-plus"></i> Create Event
      </button>
    </form>

    <!-- Event Code Output -->
    <div id="eventCodeContainer" style="display: none; margin-top: 20px;">
      <p>Your event has been created! 🎉</p>
      <div style="display: flex; align-items: center;">
        <input type="text" id="eventCode" readonly style="padding: 8px; margin-right: 10px; border: 1px solid #ccc;" />
        <button onclick="copyEventCode()" type="button">Copy Code</button>
      </div>
    </div>

  </div>
</div>


  <!-- Event Modal -->
  <div id="eventModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3 id="eventModalTitle">Event Details</h3>
      <div id="eventModalContent"></div>
      <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
        <button id="joinEventBtn" class="btn-primary">
          <i class="fas fa-plus"></i> Join Event
        </button>
        <button onclick="closeEventModal()" class="btn-secondary">
          Close
        </button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    // Global variables
    let currentUser = null;
    let userEvents = [];
    let availableEvents = [];
    let map = null;
    let routingControl = null;
    let currentUserLocation = null;
    let auth;

    // Initialize Firebase
    async function initializeFirebase() {
      try {
        const response = await fetch('https://routify-4fza.onrender.com/firebaseconfig');
        if (!response.ok) throw new Error('Failed to fetch Firebase config');
        const firebaseConfig = await response.json();
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        return auth;
      } catch (error) {
        console.error('Firebase initialization error:', error);
        showNotification('Failed to initialize Firebase. Please try again later.', 'error');
        throw error;
      }
    }

    // Initialize dashboard on load
    window.addEventListener('load', async () => {
      try {
        await initializeFirebase();
        await checkAuthentication();
        loadUserProfile();
        setupEventListeners();
        initializeMap();
        initializeSampleData(); // Add sample events if none exist
        // Load events for the default active tab
        loadMyEvents();
        loadAvailableEvents();
      } catch (error) {
        console.error('Initialization error:', error);
        showNotification('Failed to initialize application', 'error');
      }
    });

    // Initialize Map
    function initializeMap() {
      // Initialize map centered on India
      map = L.map('map').setView([20.5937, 78.9629], 5);
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);
      
      // Add click event to map
      map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Reverse geocoding to get address
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
          .then(response => response.json())
          .then(data => {
            const address = data.display_name;
            
            // If start is empty, fill it, otherwise fill destination
            const startInput = document.getElementById('start');
            const destInput = document.getElementById('destination');
            
            if (!startInput.value) {
              startInput.value = address;
            } else if (!destInput.value) {
              destInput.value = address;
            }
          })
          .catch(error => console.error('Error:', error));
      });
    }

    // Get Current Location
    function getCurrentLocation() {
      if (!navigator.geolocation) {
        showNotification('Geolocation is not supported by this browser', 'error');
        return;
      }

      showNotification('Getting your location...', 'info');
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          
          currentUserLocation = { lat, lng };
          
          // Center map on user location
          map.setView([lat, lng], 15);
          
          // Add marker for user location
          L.marker([lat, lng])
            .addTo(map)
            .bindPopup('Your Location')
            .openPopup();
          
          // Reverse geocoding to get address
          fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(response => response.json())
            .then(data => {
              document.getElementById('start').value = data.display_name;
              showNotification('Location set as starting point', 'success');
            })
            .catch(error => {
              console.error('Error:', error);
              showNotification('Got location but could not get address', 'info');
            });
        },
        function(error) {
          console.error('Error getting location:', error);
          showNotification('Unable to get your location. Please check permissions.', 'error');
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    }

    // Find Route
    function findRoute() {
      const start = document.getElementById('start').value.trim();
      const destination = document.getElementById('destination').value.trim();
      
      if (!start || !destination) {
        showNotification('Please enter both start and destination locations', 'error');
        return;
      }
      
      showNotification('Finding route...', 'info');
      
      // Geocode start and destination
      Promise.all([
        geocodeLocation(start),
        geocodeLocation(destination)
      ]).then(([startCoords, destCoords]) => {
        if (!startCoords || !destCoords) {
          showNotification('Could not find one or both locations', 'error');
          return;
        }
        
        // Clear existing route
        if (routingControl) {
          map.removeControl(routingControl);
        }
        
        // Create route
        const transportMode = document.getElementById('transportMode').value;
        let routingMode = 'driving';
        
        switch(transportMode) {
          case 'walking': routingMode = 'foot'; break;
          case 'cycling': routingMode = 'bicycle'; break;
          case 'driving': routingMode = 'driving'; break;
          default: routingMode = 'driving';
        }
        
        routingControl = L.Routing.control({
          waypoints: [
            L.latLng(startCoords.lat, startCoords.lng),
            L.latLng(destCoords.lat, destCoords.lng)
          ],
          routeWhileDragging: true,
          addWaypoints: false,
          router: L.Routing.osrmv1({
            serviceUrl: `https://router.project-osrm.org/route/v1/${routingMode}/`
          }),
          createMarker: function(i, waypoint, n) {
            const marker = L.marker(waypoint.latLng, {
              icon: L.divIcon({
                className: 'custom-marker',
                html: i === 0 ? '<i class="fas fa-play-circle" style="color: #28a745; font-size: 20px;"></i>' : '<i class="fas fa-stop-circle" style="color: #dc3545; font-size: 20px;"></i>',
                iconSize: [20, 20]
              })
            });
            
            return marker;
          }
        }).addTo(map);
        
        routingControl.on('routesfound', function(e) {
          const routes = e.routes;
          const summary = routes[0].summary;
          
          // Display route information
          const distance = (summary.totalDistance / 1000).toFixed(2);
          const time = Math.round(summary.totalTime / 60);
          
          const routeInfo = document.getElementById('routeInfo');
          const routeDetails = document.getElementById('routeDetails');
          
          const transportIcon = {
            'driving': '🚗',
            'walking': '🚶',
            'cycling': '🚴',
            'transit': '🚌',
            'train': '🚂'
          };
          
          routeDetails.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
              <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${transportIcon[transportMode]}</div>
                <div style="font-weight: 600; color: var(--primary-blue);">${distance} km</div>
                <div style="font-size: 0.8rem; color: #666;">Distance</div>
              </div>
              <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⏱️</div>
                <div style="font-weight: 600; color: var(--primary-blue);">${time} min</div>
                <div style="font-size: 0.8rem; color: #666;">Duration</div>
              </div>
              <div style="text-align: center; padding: 1rem; background: white; border-radius: 8px;">
                <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🗺️</div>
                <div style="font-weight: 600; color: var(--primary-blue);">${transportMode}</div>
                <div style="font-size: 0.8rem; color: #666;">Mode</div>
              </div>
            </div>
          `;
          
          routeInfo.style.display = 'block';
          showNotification('Route found successfully!', 'success');
        });
        
      }).catch(error => {
        console.error('Error finding route:', error);
        showNotification('Error finding route. Please try again.', 'error');
      });
    }

    // Geocode Location
    function geocodeLocation(address) {
      return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.length > 0) {
            return {
              lat: parseFloat(data[0].lat),
              lng: parseFloat(data[0].lon)
            };
          }
          return null;
        });
    }

    // Clear Route
    function clearRoute() {
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
      }
      
      // Clear inputs
      document.getElementById('start').value = '';
      document.getElementById('destination').value = '';
      
      // Hide route info
      document.getElementById('routeInfo').style.display = 'none';
      
      // Reset map view
      map.setView([20.5937, 78.9629], 5);
      
      showNotification('Route cleared', 'info');
    }

    // Logout function
    async function logout() {
      try {
        // Sign out from Firebase if available
        if (auth) {
          await auth.signOut();
        }
        
        // Clear local storage
        localStorage.removeItem('routify_user');
        localStorage.removeItem('locationSharingEnabled');
        
        // Clear any other app-specific data
        currentUser = null;
        userEvents = [];
        currentUserLocation = null;
        
        showNotification('Logged out successfully', 'success');
        
        // Redirect to login page
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
      } catch (error) {
        console.error('Logout error:', error);
        showNotification('Error during logout. Please try again.', 'error');
      }
    }

    // Authentication Check
    async function checkAuthentication() {
      return new Promise((resolve, reject) => {
        // Check Firebase auth state
        auth.onAuthStateChanged(async (firebaseUser) => {
          if (firebaseUser) {
            // User is signed in with Firebase
            currentUser = {
              username: firebaseUser.displayName || firebaseUser.email.split('@')[0],
              email: firebaseUser.email,
              uid: firebaseUser.uid,
              loggedIn: true,
              firebaseVerified: true,
              loginTime: new Date().toISOString()
            };

            // Store the current user data
            localStorage.setItem('routify_user', JSON.stringify(currentUser));
            
            // Update welcome message
            document.getElementById('welcomeUser').textContent = `Welcome back, ${currentUser.username}!`;
            
            // Update user subtext
            let subtext = 'Manage your events and connect with others!';
            if (currentUser.digilockerVerified) {
              subtext = '🛡️ Verified Account • Host amazing events!';
            }
            document.getElementById('userSubtext').textContent = subtext;
            
            resolve(currentUser);
          } else {
            // No Firebase user, check local storage as fallback
            const localUser = localStorage.getItem('routify_user');
            
            if (!localUser) {
              window.location.href = 'login.html';
              reject(new Error('No authenticated user'));
              return;
            }
            
            try {
              const userData = JSON.parse(localUser);
              if (!userData.loggedIn) {
                localStorage.removeItem('routify_user');
                window.location.href = 'login.html';
                reject(new Error('User not logged in'));
                return;
              }
              
              currentUser = userData;
              document.getElementById('welcomeUser').textContent = `Welcome back, ${userData.username}!`;
              
              let subtext = 'Manage your events and connect with others!';
              if (userData.digilockerVerified) {
                subtext = '🛡️ Verified Account • Host amazing events!';
              }
              document.getElementById('userSubtext').textContent = subtext;
              
              resolve(userData);
            } catch (error) {
              localStorage.removeItem('routify_user');
              window.location.href = 'login.html';
              reject(error);
            }
          }
        });
      });
    }

    // Load User Profile
    function loadUserProfile() {
      if (!currentUser) return;

      // Load basic profile info
      document.getElementById('profileUsername').textContent = currentUser.username;
      document.getElementById('profileHandle').textContent = currentUser.username.toLowerCase();
      document.getElementById('profileEmail').textContent = currentUser.email || 'Email not provided';
      
      // Load account details and badges
      const accountType = currentUser.digilockerVerified ? 'Verified' : 'Standard';
      const accountBadge = document.getElementById('accountTypeBadge');
      accountBadge.textContent = accountType;
      accountBadge.className = `profile-badge ${accountType.toLowerCase()}`;
      
      // Format member since date
      const memberSince = currentUser.signupTime || currentUser.loginTime || new Date().toISOString();
      const memberDate = new Date(memberSince).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      document.getElementById('memberSince').textContent = memberDate;
      
      // Verification status badge
      const verificationBadge = document.getElementById('verificationBadge');
      let verificationStatus = 'Not Verified';
      let badgeClass = 'profile-badge verification unverified';
      
      if (currentUser.digilockerVerified && currentUser.firebaseVerified) {
        verificationStatus = '✅ Fully Verified';
        badgeClass = 'profile-badge verification verified';
      } else if (currentUser.digilockerVerified) {
        verificationStatus = '🛡️ Digilocker Verified';
        badgeClass = 'profile-badge verification partial';
      } else if (currentUser.firebaseVerified || currentUser.authMethod === 'firebase') {
        verificationStatus = '🔐 Firebase Verified';
        badgeClass = 'profile-badge verification partial';
      }
      
      verificationBadge.textContent = verificationStatus;
      verificationBadge.className = badgeClass;
      
      // Setup location sharing
      setupLocationSharing();
      
      // Load user stats
      updateUserStats();
      
      // Listen for changes to friends list in localStorage
      window.addEventListener('storage', function(e) {
        if (e.key && e.key.startsWith('friends_') && currentUser && e.key === `friends_${currentUser.email}`) {
          updateUserStats();
        }
      });
      
      // Also listen for custom events from friends page
      window.addEventListener('friendsUpdated', function() {
        updateUserStats();
      });
    }

    // Setup Location Sharing
    function setupLocationSharing() {
      const locationToggle = document.getElementById('shareLocationWithFollowers');
      
      // Check if location sharing was previously enabled
      const wasEnabled = localStorage.getItem('locationSharingEnabled') === 'true';
      
      // Initialize UI based on saved state
      if (wasEnabled) {
        updateLocationUI('enabled');
        if (locationToggle) {
          locationToggle.checked = true;
        }
        updateLocationSharingStatus(true);
        
        // Try to restore location tracking if permission is still granted
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              currentUserLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                timestamp: new Date().toISOString(),
                sharedWith: 'followers'
              };
              startLocationTracking();
            },
            function(error) {
              // Permission denied or error, reset to disabled
              disableLocationSharing();
            }
          );
        }
      } else {
        updateLocationUI('disabled');
        updateLocationSharingStatus(false);
      }
      
      // Add event listener for profile toggle if it exists
      if (locationToggle) {
        locationToggle.addEventListener('change', function() {
          if (this.checked) {
            enableLocationSharing();
          } else {
            disableLocationSharing();
          }
        });
      }
    }

    // Enable Location Sharing (Updated with direct permission handling)
    function enableLocationSharing() {
      // Request location permission directly without modal
      requestLocationPermission();
    }

    // Disable Location Sharing (Updated)
    function disableLocationSharing() {
      currentUserLocation = null;
      localStorage.setItem('locationSharingEnabled', 'false');
      
      // Update UI to show disabled state
      updateLocationUI('disabled');
      
      // Also update the profile toggle
      const profileToggle = document.getElementById('shareLocationWithFollowers');
      if (profileToggle) {
        profileToggle.checked = false;
      }
      updateLocationSharingStatus(false);
      
      showNotification('Location sharing disabled', 'info');
      
      if (window.locationTrackingInterval) {
        clearInterval(window.locationTrackingInterval);
      }
    }

    // Update Location UI
    function updateLocationUI(state) {
      const enableBtn = document.getElementById('enableLocationBtn');
      const disableBtn = document.getElementById('disableLocationBtn');
      const statusText = document.getElementById('locationStatusText');
      const locationDetails = document.getElementById('locationDetails');
      
      switch(state) {
        case 'requesting':
          enableBtn.style.display = 'none';
          disableBtn.style.display = 'none';
          statusText.textContent = 'Requesting location access...';
          statusText.style.color = '#ffc107';
          locationDetails.style.display = 'none';
          
          // Show a temporary requesting button
          const requestingBtn = document.createElement('button');
          requestingBtn.id = 'requestingLocationBtn';
          requestingBtn.className = 'btn-secondary';
          requestingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Requesting...';
          requestingBtn.disabled = true;
          enableBtn.parentNode.appendChild(requestingBtn);
          break;
          
        case 'enabled':
          // Remove requesting button if exists
          const requestingBtn2 = document.getElementById('requestingLocationBtn');
          if (requestingBtn2) requestingBtn2.remove();
          
          enableBtn.style.display = 'none';
          disableBtn.style.display = 'inline-flex';
          statusText.textContent = 'Location sharing is enabled';
          statusText.style.color = '#28a745';
          locationDetails.style.display = 'block';
          break;
          
        case 'disabled':
        default:
          // Remove requesting button if exists
          const requestingBtn3 = document.getElementById('requestingLocationBtn');
          if (requestingBtn3) requestingBtn3.remove();
          
          enableBtn.style.display = 'inline-flex';
          disableBtn.style.display = 'none';
          statusText.textContent = 'Location sharing is disabled';
          statusText.style.color = '#666';
          locationDetails.style.display = 'none';
          break;
      }
    }

    // Enable Location Sharing with Followers Only (Profile Toggle)
    function enableLocationSharingWithFollowers() {
      // Use the main enableLocationSharing function for consistency
      enableLocationSharing();
    }

    // Disable Location Sharing (Updated)
    function disableLocationSharing() {
      currentUserLocation = null;
      localStorage.setItem('locationSharingEnabled', 'false');
      
      // Update main location UI
      updateLocationUI('disabled');
      
      // Also update the profile toggle if it exists
      const profileToggle = document.getElementById('shareLocationWithFollowers');
      if (profileToggle) {
        profileToggle.checked = false;
      }
      updateLocationSharingStatus(false);
      
      showNotification('Location sharing disabled', 'info');
      
      if (window.locationTrackingInterval) {
        clearInterval(window.locationTrackingInterval);
      }
    }

    // Update Location Sharing Status Display
    function updateLocationSharingStatus(isEnabled) {
      const statusIndicator = document.querySelector('.status-indicator');
      const statusText = document.querySelector('.status-text');
      
      if (isEnabled) {
        statusIndicator.className = 'status-indicator online';
        statusText.textContent = 'Sharing location with followers';
      } else {
        statusIndicator.className = 'status-indicator offline';
        statusText.textContent = 'Location sharing is disabled';
      }
    }

    // Start Location Tracking
    function startLocationTracking() {
      // Update location every 5 minutes
      window.locationTrackingInterval = setInterval(() => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              currentUserLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                timestamp: new Date().toISOString(),
                sharedWith: 'followers'
              };
              
              // In a real app, this would send location to server
              console.log('Location updated for followers:', currentUserLocation);
            },
            function(error) {
              console.error('Location update failed:', error);
            }
          );
        }
      }, 300000); // 5 minutes
    }

    // Profile Actions
    function editProfile() {
      showNotification('Edit profile feature coming soon!', 'info');
    }

    function shareProfile() {
      if (navigator.share) {
        navigator.share({
          title: `${currentUser.username}'s Profile`,
          text: `Check out ${currentUser.username}'s profile on Routify!`,
          url: window.location.href
        });
      } else {
        // Fallback: copy to clipboard
        const profileUrl = window.location.href;
        navigator.clipboard.writeText(profileUrl).then(() => {
          showNotification('Profile link copied to clipboard!', 'success');
        }).catch(() => {
          showNotification('Unable to copy link', 'error');
        });
      }
    }

    // Update User Stats
    function updateUserStats() {
      const myRoutesCount = userEvents.length; // keeping userEvents array name for compatibility
      
      // Get actual friend count from localStorage
      let followersCount = 0;
      if (currentUser && currentUser.email) {
        const friends = localStorage.getItem(`friends_${currentUser.email}`);
        followersCount = friends ? JSON.parse(friends).length : 0;
      }
      const followingCount = followersCount; // In this context, friends are mutual followers

      document.getElementById('myRoutesCount').textContent = myRoutesCount;
      document.getElementById('followersCount').textContent = followersCount;
      document.getElementById('followingCount').textContent = followingCount;
      
      // Update profile stats
      document.getElementById('profileFollowers').textContent = followersCount;
      document.getElementById('profileFollowing').textContent = followingCount;
      document.getElementById('profileEvents').textContent = myRoutesCount;
    }

    // Tab Switching
    function switchTab(tabName) {
      // Remove active class from all tabs and content
      document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked tab button
      event.target.classList.add('active');
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Load tab-specific content
      if (tabName === 'my-events') {
        loadMyEvents();
      } else if (tabName === 'join-event') {
        loadAvailableEvents();
      }
    }

    // Setup Event Listeners
    function setupEventListeners() {
      // Create event form
      document.getElementById('createEventForm').addEventListener('submit', handleCreateEvent);
      
      // Search events
      document.getElementById('eventSearch').addEventListener('input', filterAvailableEvents);
      document.getElementById('locationFilter').addEventListener('input', filterAvailableEvents);
      document.getElementById('categoryFilter').addEventListener('change', filterAvailableEvents);
    }

    // Handle Create Event
    function handleCreateEvent(e) {
      e.preventDefault();
      
      const eventId = generateEventId();
      const eventCode = generateEventCode();
      
      const formData = {
        id: eventId,
        title: document.getElementById('eventTitle').value,
        description: document.getElementById('eventDescription').value,
        date: document.getElementById('eventDate').value,
        time: document.getElementById('eventTime').value,
        location: document.getElementById('eventLocation').value,
        maxParticipants: document.getElementById('maxParticipants').value || 'Unlimited',
        category: document.getElementById('eventCategory').value,
        price: document.getElementById('eventPrice').value || 'Free',
        isPublic: document.getElementById('isPublicEvent').checked,
        organizer: currentUser.username,
        participants: [currentUser.username],
        createdAt: new Date().toISOString(),
        code: eventCode
      };
      
      // Store event code mapping
      const eventCodes = JSON.parse(localStorage.getItem('eventCodes') || '{}');
      eventCodes[eventCode] = eventId;
      localStorage.setItem('eventCodes', JSON.stringify(eventCodes));
      
      // Add to user events
      userEvents.push(formData);
      
      // Add to available events if public
      if (formData.isPublic) {
        availableEvents.push(formData);
      }
      
      // Save to localStorage
      localStorage.setItem('userEvents', JSON.stringify(userEvents));
      localStorage.setItem('availableEvents', JSON.stringify(availableEvents));
      
      // Show event code to user
      const eventCodeContainer = document.getElementById('eventCodeContainer');
      const eventCodeInput = document.getElementById('eventCode');
      eventCodeInput.value = eventCode;
      eventCodeContainer.style.display = 'block';
      
      // Reset form
      document.getElementById('createEventForm').reset();
      
      // Update stats
      updateUserStats();
      
      // Switch to My Events tab to show created event
      switchTabProgrammatically('my-events');
      
      showNotification('Event created successfully!', 'success');
    }

    // Generate Event Code
    function generateEventCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = 'EVNT-';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Initialize Sample Data if needed
    function initializeSampleData() {
      // Check if there are any available events, if not add some samples
      const savedAvailableEvents = localStorage.getItem('availableEvents');
      if (!savedAvailableEvents || JSON.parse(savedAvailableEvents).length === 0) {
        const sampleEvents = [
          {
            id: 'event_sample_1',
            title: 'City Food Festival',
            description: 'Join us for a fantastic food festival featuring local vendors and live music.',
            date: '2025-08-25',
            time: '18:00',
            location: 'Central Park, Delhi',
            organizer: 'FoodieEvents',
            code: 'EVNT-FD2025',
            maxParticipants: 100,
            currentParticipants: 23,
            price: 'Free',
            category: 'food',
            participants: ['FoodieEvents', 'user1', 'user2']
          },
          {
            id: 'event_sample_2', 
            title: 'Tech Meetup 2025',
            description: 'Network with fellow developers and learn about the latest tech trends.',
            date: '2025-08-28',
            time: '19:00',
            location: 'Tech Hub, Bangalore',
            organizer: 'TechCommunity',
            code: 'EVNT-TC2025',
            maxParticipants: 50,
            currentParticipants: 12,
            price: '500',
            category: 'business',
            participants: ['TechCommunity', 'dev1', 'dev2']
          },
          {
            id: 'event_sample_3',
            title: 'Morning Yoga Session',
            description: 'Start your day with peaceful yoga by the lake. All levels welcome.',
            date: '2025-08-22',
            time: '07:00',
            location: 'Lakeview Park, Mumbai',
            organizer: 'WellnessEvents',
            code: 'EVNT-YG2025',
            maxParticipants: 30,
            currentParticipants: 8,
            price: '200',
            category: 'sports',
            participants: ['WellnessEvents', 'yogi1']
          }
        ];
        
        // Store event codes mapping
        const eventCodes = {
          'EVNT-FD2025': 'event_sample_1',
          'EVNT-TC2025': 'event_sample_2',
          'EVNT-YG2025': 'event_sample_3'
        };
        
        localStorage.setItem('availableEvents', JSON.stringify(sampleEvents));
        localStorage.setItem('eventCodes', JSON.stringify(eventCodes));
        availableEvents = sampleEvents;
      }
    }

    // Load My Events
    function loadMyEvents() {
      const container = document.getElementById('myEventsContainer');
      const noEventsDiv = document.getElementById('noMyEvents');
      const eventsListDiv = document.getElementById('myEventsList');
      
      // Load from localStorage
      const savedEvents = localStorage.getItem('userEvents');
      if (savedEvents) {
        userEvents = JSON.parse(savedEvents);
      }
      
      if (userEvents.length === 0) {
        noEventsDiv.style.display = 'block';
        eventsListDiv.style.display = 'none';
      } else {
        noEventsDiv.style.display = 'none';
        eventsListDiv.style.display = 'block';
        
        eventsListDiv.innerHTML = '';
        userEvents.forEach(event => {
          const eventCard = createEventCard(event, 'my-event');
          eventsListDiv.appendChild(eventCard);
        });
      }
    }

    // Load Available Events
    function loadAvailableEvents() {
      const container = document.getElementById('availableEventsContainer');
      const noEventsDiv = document.getElementById('noAvailableEvents');
      const eventsListDiv = document.getElementById('availableEventsList');
      
      // Load from localStorage
      const savedEvents = localStorage.getItem('availableEvents');
      if (savedEvents) {
        availableEvents = JSON.parse(savedEvents);
      }
      
      // Filter out user's own events
      const otherEvents = availableEvents.filter(event => 
        event.organizer !== currentUser.username
      );
      
      if (otherEvents.length === 0) {
        noEventsDiv.style.display = 'block';
        eventsListDiv.style.display = 'none';
      } else {
        noEventsDiv.style.display = 'none';
        eventsListDiv.style.display = 'block';
        
        eventsListDiv.innerHTML = '';
        otherEvents.forEach(event => {
          const eventCard = createEventCard(event, 'join-event');
          eventsListDiv.appendChild(eventCard);
        });
      }
    }

    // Create Event Card
    function createEventCard(event, type) {
      const card = document.createElement('div');
      card.className = 'dashboard-card event-card';
      card.style.cursor = 'pointer';
      
      const categoryEmoji = {
        sports: '🏃', music: '🎵', food: '🍽️', travel: '✈️',
        business: '💼', education: '📚', social: '👥'
      };
      
      const isJoined = event.participants && event.participants.includes(currentUser.username);
      const joinButton = type === 'join-event' ? 
        (isJoined ? 
          '<span style="color: var(--success-green); font-weight: 600;"><i class="fas fa-check"></i> Joined</span>' :
          '<button onclick="joinEvent(\'' + event.id + '\')" class="btn-primary"><i class="fas fa-plus"></i> Join</button>'
        ) : '';
      
      card.innerHTML = `
        <div onclick="showEventDetails('${event.id}')">
          <h4>${event.title} ${categoryEmoji[event.category] || '📅'}</h4>
          <p style="color: #666; margin: 0.5rem 0;">${event.description}</p>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
            <div style="font-size: 0.9rem; color: #888;">
              <div><i class="fas fa-calendar"></i> ${new Date(event.date).toLocaleDateString()}</div>
              <div><i class="fas fa-clock"></i> ${event.time}</div>
              <div><i class="fas fa-map-marker-alt"></i> ${event.location}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 0.8rem; color: #666;">
                ${event.participants ? event.participants.length : 1}/${event.maxParticipants === 'Unlimited' ? '∞' : event.maxParticipants} participants
              </div>
              <div style="font-weight: 600; color: var(--primary-blue);">
                ${event.price === 'Free' ? 'Free' : '₹' + event.price}
              </div>
            </div>
          </div>
        </div>
        <div style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 0.8rem; color: #999;">
              by ${event.organizer}
            </span>
            ${joinButton}
          </div>
        </div>
      `;
      
      return card;
    }

    // Join Event
    function joinEvent(eventId) {
      const eventIndex = availableEvents.findIndex(event => event.id === eventId);
      if (eventIndex === -1) return;
      
      const event = availableEvents[eventIndex];
      
      // Check if already joined
      if (event.participants && event.participants.includes(currentUser.username)) {
        showNotification('You have already joined this event!', 'info');
        return;
      }
      
      // Add user to participants
      if (!event.participants) event.participants = [];
      event.participants.push(currentUser.username);
      
      // Update localStorage
      localStorage.setItem('availableEvents', JSON.stringify(availableEvents));
      
      // Refresh the view
      loadAvailableEvents();
      
      showNotification('Successfully joined the event!', 'success');
    }

    // Search Events
    function searchEvents() {
      filterAvailableEvents();
    }

    // Filter Available Events
    function filterAvailableEvents() {
      const searchTerm = document.getElementById('eventSearch').value.toLowerCase();
      const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      
      const eventsListDiv = document.getElementById('availableEventsList');
      const eventCards = eventsListDiv.querySelectorAll('.event-card');
      
      eventCards.forEach(card => {
        const title = card.querySelector('h4').textContent.toLowerCase();
        const description = card.querySelector('p').textContent.toLowerCase();
        const location = card.textContent.toLowerCase();
        
        const matchesSearch = !searchTerm || title.includes(searchTerm) || description.includes(searchTerm);
        const matchesLocation = !locationFilter || location.includes(locationFilter);
        const matchesCategory = !categoryFilter; // Will implement category matching when needed
        
        card.style.display = (matchesSearch && matchesLocation && matchesCategory) ? 'block' : 'none';
      });
    }

    // Show Event Details
    function showEventDetails(eventId) {
      // Implementation for showing event details modal
      console.log('Show details for event:', eventId);
    }

    // Close Event Modal
    function closeEventModal() {
      document.getElementById('eventModal').style.display = 'none';
    }

    // Switch Tab Programmatically
    function switchTabProgrammatically(tabName) {
      // Find the tab button and trigger click
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(button => {
        if (button.onclick && button.onclick.toString().includes(tabName)) {
          button.click();
        }
      });
    }

    // User Search Functions
    function searchUsers() {
      const searchTerm = document.getElementById('userSearch').value.trim().toLowerCase();
      
      if (!searchTerm) {
        showNotification('Please enter a search term', 'error');
        return;
      }
      
      // Get all registered users from a simulated user database
      const allUsers = getAllRegisteredUsers();
      
      // Filter users based on search term
      const matchingUsers = allUsers.filter(user => 
        user.username.toLowerCase().includes(searchTerm) || 
        (user.email && user.email.toLowerCase().includes(searchTerm))
      );
      
      // Remove current user from results
      const filteredUsers = matchingUsers.filter(user => user.username !== currentUser.username);
      
      displayUserSearchResults(filteredUsers);
    }

    function getAllRegisteredUsers() {
      // Simulate getting users from a database
      // In a real app, this would be an API call
      const savedUsers = localStorage.getItem('allUsers');
      let allUsers = [];
      
      if (savedUsers) {
        allUsers = JSON.parse(savedUsers);
      }
      
      // Add current user to the database if not already there
      const currentUserExists = allUsers.some(user => user.username === currentUser.username);
      if (!currentUserExists) {
        const userToAdd = {
          username: currentUser.username,
          email: currentUser.email,
          verified: currentUser.digilockerVerified || false,
          authMethod: currentUser.authMethod,
          joinDate: currentUser.signupTime || currentUser.loginTime || new Date().toISOString()
        };
        allUsers.push(userToAdd);
        localStorage.setItem('allUsers', JSON.stringify(allUsers));
      }
      
      return allUsers;
    }

    function displayUserSearchResults(users) {
      const resultsContainer = document.getElementById('userSearchResults');
      const resultsList = document.getElementById('userResultsList');
      
      if (users.length === 0) {
        resultsContainer.style.display = 'block';
        resultsList.innerHTML = `
          <div style="text-align: center; padding: 2rem; color: #666;">
            <i class="fas fa-user-slash" style="font-size: 2rem; margin-bottom: 1rem;"></i>
            <p>No users found matching your search.</p>
          </div>
        `;
        return;
      }
      
      resultsContainer.style.display = 'block';
      resultsList.innerHTML = '';
      
      users.forEach(user => {
        const userCard = createUserCard(user);
        resultsList.appendChild(userCard);
      });
    }

    function createUserCard(user) {
      const card = document.createElement('div');
      card.className = 'user-card';
      
      const joinDate = new Date(user.joinDate).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short'
      });
      
      const verificationBadge = user.verified ? 
        '<span class="verification-badge">✅ Verified</span>' : 
        '<span class="verification-badge unverified">Not Verified</span>';
      
      card.innerHTML = `
        <div class="user-card-content">
          <div class="user-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="user-info">
            <h4>${user.username}</h4>
            <p>${user.email || 'Email not public'}</p>
            <div class="user-meta">
              <span class="join-date">Joined ${joinDate}</span>
              ${verificationBadge}
            </div>
          </div>
          <div class="user-actions">
            <button onclick="followUser('${user.username}')" class="btn-secondary">
              <i class="fas fa-user-plus"></i> Follow
            </button>
            <button onclick="messageUser('${user.username}')" class="btn-primary">
              <i class="fas fa-envelope"></i> Message
            </button>
          </div>
        </div>
      `;
      
      return card;
    }

    function followUser(username) {
      // Implement follow functionality
      showNotification(`Following ${username}! (Feature coming soon)`, 'info');
    }

    function messageUser(username) {
      // Implement messaging functionality
      showNotification(`Messaging ${username}! (Feature coming soon)`, 'info');
    }

    // Utility Functions
    function generateEventId() {
      return 'event_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
      
      Object.assign(notification.style, {
        position: 'fixed',
        top: '20px',
        right: '20px',
        padding: '15px 20px',
        borderRadius: '8px',
        color: 'white',
        fontWeight: '500',
        zIndex: '1000',
        transform: 'translateX(100%)',
        transition: 'transform 0.3s ease',
        backgroundColor: type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'
      });
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.style.transform = 'translateX(0)', 100);
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // Logout Function
    function logout() {
      localStorage.removeItem('routify_user');
      localStorage.removeItem('userEvents');
      window.location.href = 'auth.html';
    }

    // Add missing CSS styles
    const additionalStyles = document.createElement('style');
    additionalStyles.textContent = `
      .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
      }
      
      .event-card {
        transition: all 0.3s ease;
        border: 1px solid #e1e5e9;
      }
      
      .event-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      }
      
      /* Instagram-style Profile Card */
      .profile-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 0;
        overflow: hidden;
        position: relative;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      }
      
      .profile-header {
        position: relative;
        height: 120px;
      }
      
      .profile-cover {
        height: 100%;
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        position: relative;
      }
      
      .profile-avatar-container {
        position: absolute;
        bottom: -40px;
        left: 50%;
        transform: translateX(-50%);
      }
      
      .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: var(--primary-blue);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        border: 4px solid white;
        position: relative;
      }
      
      .profile-status-indicator {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid white;
      }
      
      .profile-status-indicator.online {
        background: #28a745;
      }
      
      .profile-status-indicator.offline {
        background: #6c757d;
      }
      
      .profile-content {
        background: white;
        margin-top: 40px;
        padding: 2rem;
        border-radius: 20px 20px 0 0;
      }
      
      .profile-main-info {
        text-align: center;
        margin-bottom: 2rem;
      }
      
      .profile-main-info h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        margin: 0 0 0.5rem 0;
      }
      
      .profile-handle {
        color: #666;
        font-size: 0.9rem;
        margin: 0 0 0.5rem 0;
      }
      
      .profile-email {
        color: #888;
        font-size: 0.8rem;
        margin: 0 0 1rem 0;
      }
      
      .profile-badges {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }
      
      .profile-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .profile-badge.standard {
        background: #e9ecef;
        color: #495057;
      }
      
      .profile-badge.verified {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
      }
      
      .profile-badge.verification.verified {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
      }
      
      .profile-badge.verification.partial {
        background: linear-gradient(135deg, #ffc107, #e0a800);
        color: white;
      }
      
      .profile-badge.verification.unverified {
        background: #6c757d;
        color: white;
      }
      
      .profile-stats-row {
        display: flex;
        justify-content: space-around;
        padding: 1rem 0;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        margin-bottom: 1rem;
      }
      
      .profile-stat {
        text-align: center;
      }
      
      .profile-stat .stat-number {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-blue);
      }
      
      .profile-stat .stat-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 0.25rem;
      }
      
      .profile-bio {
        text-align: center;
        margin-bottom: 1.5rem;
      }
      
      .profile-bio p {
        color: #333;
        font-size: 0.9rem;
        line-height: 1.4;
        margin: 0;
      }
      
      .profile-meta-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }
      
      .meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #666;
        font-size: 0.85rem;
      }
      
      .meta-item i {
        width: 16px;
        color: var(--primary-blue);
      }
      
      /* Location Sharing Section */
      .location-sharing-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
      }
      
      .location-toggle-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      
      .location-toggle-header h4 {
        margin: 0;
        font-size: 0.9rem;
        color: var(--primary-blue);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .location-toggle-switch {
        position: relative;
      }
      
      .toggle-label {
        display: inline-block;
        width: 50px;
        height: 24px;
        background: #ccc;
        border-radius: 24px;
        cursor: pointer;
        position: relative;
        transition: background 0.3s ease;
      }
      
      .toggle-label::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      .toggle-checkbox:checked + .toggle-label {
        background: var(--success-green);
      }
      
      .toggle-checkbox:checked + .toggle-label::after {
        transform: translateX(26px);
      }
      
      .toggle-checkbox {
        display: none;
      }
      
      .location-sharing-description {
        font-size: 0.8rem;
        color: #666;
        margin: 0 0 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .location-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
      }
      
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }
      
      .status-indicator.online {
        background: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.3);
      }
      
      .status-indicator.offline {
        background: #6c757d;
      }
      
      .status-text {
        font-weight: 500;
      }
      
      /* Profile Actions */
      .profile-actions {
        display: flex;
        gap: 1rem;
      }
      
      .btn-profile-primary {
        flex: 1;
        background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      
      .btn-profile-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 119, 182, 0.3);
      }
      
      .btn-profile-secondary {
        flex: 1;
        background: transparent;
        color: var(--primary-blue);
        border: 2px solid var(--primary-blue);
        padding: 12px 20px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }
      
      .btn-profile-secondary:hover {
        background: var(--primary-blue);
        color: white;
        transform: translateY(-2px);
      }
      
      .user-search-section {
        margin-bottom: 2rem;
      }
      
      .user-results-grid {
        margin-top: 2rem;
        padding: 1rem 0;
        border-top: 1px solid #eee;
      }
      
      .user-results-grid h4 {
        color: var(--primary-blue);
        margin-bottom: 1rem;
      }
      
      .user-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        border: 1px solid #e1e5e9;
      }
      
      .user-card:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      
      .user-card-content {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      
      .user-avatar {
        font-size: 2.5rem;
        color: var(--primary-blue);
      }
      
      .user-info {
        flex: 1;
      }
      
      .user-info h4 {
        margin: 0 0 0.25rem 0;
        color: var(--primary-blue);
      }
      
      .user-info p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
      }
      
      .user-meta {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 0.5rem;
      }
      
      .join-date {
        font-size: 0.8rem;
        color: #999;
      }
      
      .verification-badge {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 12px;
        background: var(--success-green);
        color: white;
      }
      
      .verification-badge.unverified {
        background: #999;
      }
      
      .user-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .user-actions button {
        padding: 6px 12px;
        font-size: 0.8rem;
        white-space: nowrap;
      }
      
      .event-search-section {
        margin-bottom: 2rem;
      }
      
      .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      
      .modal-content {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        width: 90%;
        max-width: 500px;
        position: relative;
      }
      
      .btn-white {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .btn-white:hover {
        background: rgba(255,255,255,0.3);
      }
      
      .checkbox-group label {
        font-size: 0.9rem;
        color: #333;
      }
      
      .checkbox-group input[type="checkbox"] {
        margin-right: 0.5rem;
      }
      
      textarea {
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        font-family: 'Poppins', sans-serif;
        resize: vertical;
      }
      
      textarea:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.1);
      }
    `;
    document.head.appendChild(additionalStyles);
  </script>
</body>
</html>
 
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner">
      <i class="fas fa-route fa-spin"></i>
      <p>Processing your request...</p>
    </div>
  </div>
  

<div id="liveLocationError" style="color:#f56565; font-size:0.95rem; margin-top:4px; display:none;"></div>
<div id="liveLocationMap" style="height:220px; margin-top:1rem; display:none;"></div>

  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
  // Enhanced Create Event Form Handler
  document.getElementById('createEventForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Gather all form data
    const title = document.getElementById('eventTitle').value;
    const description = document.getElementById('eventDescription').value;
    const date = document.getElementById('eventDate').value;
    const time = document.getElementById('eventTime').value;
    const location = document.getElementById('eventLocation').value;
    const maxParticipants = document.getElementById('maxParticipants').value || 'Unlimited';
    const category = document.getElementById('eventCategory').value;
    const price = document.getElementById('eventPrice').value || 'Free';
    const isPublic = document.getElementById('isPublicEvent').checked;

    // Validate required fields
    if (!title || !description || !date || !time || !location || !category) {
      alert('Please fill in all required fields');
      return;
    }

    // Generate unique event code
    const eventCode = 'EVNT-' + Math.random().toString(36).substring(2, 8).toUpperCase();

    // Create event object
    const eventData = {
      id: 'event_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      code: eventCode,
      title: title,
      description: description,
      date: date,
      time: time,
      location: location,
      maxParticipants: maxParticipants,
      category: category,
      price: price === 'Free' ? 'Free' : '₹' + price,
      isPublic: isPublic,
      organizer: currentUser ? currentUser.username : 'Anonymous',
      participants: [currentUser ? currentUser.username : 'Anonymous'],
      createdAt: new Date().toISOString()
    };

    // Store event in localStorage
    let userEvents = JSON.parse(localStorage.getItem('userEvents') || '[]');
    let availableEvents = JSON.parse(localStorage.getItem('availableEvents') || '[]');
    let eventCodes = JSON.parse(localStorage.getItem('eventCodes') || '{}');

    // Add event to arrays
    userEvents.push(eventData);
    if (isPublic) {
      availableEvents.push(eventData);
    }
    
    // Store event code mapping
    eventCodes[eventCode] = eventData.id;

    // Save to localStorage
    localStorage.setItem('userEvents', JSON.stringify(userEvents));
    localStorage.setItem('availableEvents', JSON.stringify(availableEvents));
    localStorage.setItem('eventCodes', JSON.stringify(eventCodes));

    // Show code in UI
    document.getElementById('eventCode').value = eventCode;
    document.getElementById('eventCodeContainer').style.display = 'block';

    // Show success message
    showNotification('Event created successfully! Share your event code with others.', 'success');

    // Update stats if function exists
    if (typeof updateUserStats === 'function') {
      updateUserStats();
    }
  });

  function copyEventCode() {
    const input = document.getElementById('eventCode');
    input.select();
    input.setSelectionRange(0, 99999);
    
    // Use modern clipboard API if available, fallback to execCommand
    if (navigator.clipboard) {
      navigator.clipboard.writeText(input.value).then(() => {
        showNotification('Event code copied: ' + input.value, 'success');
      }).catch(() => {
        document.execCommand('copy');
        showNotification('Event code copied: ' + input.value, 'success');
      });
    } else {
      document.execCommand('copy');
      showNotification('Event code copied: ' + input.value, 'success');
    }
  }

  // Join Event by Code Function
  function joinEventByCode() {
    const codeInput = document.getElementById('eventCodeInput');
    const resultDiv = document.getElementById('joinCodeResult');
    const eventCode = codeInput.value.trim().toUpperCase();

    if (!eventCode) {
      showNotification('Please enter an event code', 'error');
      return;
    }

    // Get event codes mapping
    const eventCodes = JSON.parse(localStorage.getItem('eventCodes') || '{}');
    const availableEvents = JSON.parse(localStorage.getItem('availableEvents') || '[]');
    const userEvents = JSON.parse(localStorage.getItem('userEvents') || '[]');

    // Find event by code
    const eventId = eventCodes[eventCode];
    let event = null;

    if (eventId) {
      // Search in available events first
      event = availableEvents.find(e => e.id === eventId);
      if (!event) {
        // Search in user events
        event = userEvents.find(e => e.id === eventId);
      }
    }

    if (!event) {
      resultDiv.style.display = 'block';
      resultDiv.style.backgroundColor = '#f8d7da';
      resultDiv.style.color = '#721c24';
      resultDiv.style.border = '1px solid #f5c6cb';
      resultDiv.innerHTML = `
        <div style="text-align: center;">
          <i class="fas fa-times-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <p><strong>Event Not Found</strong></p>
          <p>The event code "${eventCode}" is invalid or the event no longer exists.</p>
        </div>
      `;
      showNotification('Invalid event code', 'error');
      return;
    }

    // Check if user is already a participant
    const currentUsername = currentUser ? currentUser.username : 'Anonymous';
    const isAlreadyJoined = event.participants && event.participants.includes(currentUsername);

    if (isAlreadyJoined) {
      resultDiv.style.display = 'block';
      resultDiv.style.backgroundColor = '#fff3cd';
      resultDiv.style.color = '#856404';
      resultDiv.style.border = '1px solid #ffeaa7';
      resultDiv.innerHTML = `
        <div style="text-align: center;">
          <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <p><strong>Already Joined</strong></p>
          <p>You are already a participant in "${event.title}"</p>
        </div>
      `;
      showNotification('You have already joined this event', 'info');
      return;
    }

    // Check if event is full
    if (event.maxParticipants !== 'Unlimited' && 
        event.participants && 
        event.participants.length >= parseInt(event.maxParticipants)) {
      resultDiv.style.display = 'block';
      resultDiv.style.backgroundColor = '#f8d7da';
      resultDiv.style.color = '#721c24';
      resultDiv.style.border = '1px solid #f5c6cb';
      resultDiv.innerHTML = `
        <div style="text-align: center;">
          <i class="fas fa-users-slash" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
          <p><strong>Event Full</strong></p>
          <p>This event has reached its maximum capacity of ${event.maxParticipants} participants.</p>
        </div>
      `;
      showNotification('Event is full', 'error');
      return;
    }

    // Add user to event participants
    if (!event.participants) {
      event.participants = [];
    }
    event.participants.push(currentUsername);

    // Update localStorage
    const eventIndex = availableEvents.findIndex(e => e.id === eventId);
    if (eventIndex !== -1) {
      availableEvents[eventIndex] = event;
      localStorage.setItem('availableEvents', JSON.stringify(availableEvents));
    }

    // Show success
    const categoryEmoji = {
      sports: '🏃', music: '🎵', food: '🍽️', travel: '✈️',
      business: '💼', education: '📚', social: '👥'
    };

    resultDiv.style.display = 'block';
    resultDiv.style.backgroundColor = '#d4edda';
    resultDiv.style.color = '#155724';
    resultDiv.style.border = '1px solid #c3e6cb';
    resultDiv.innerHTML = `
      <div style="text-align: center;">
        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
        <p><strong>Successfully Joined!</strong></p>
        <div style="background: white; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: left;">
          <h4>${event.title} ${categoryEmoji[event.category] || '📅'}</h4>
          <p style="margin: 0.5rem 0; color: #666;">${event.description}</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
            <div><i class="fas fa-calendar"></i> ${new Date(event.date).toLocaleDateString()}</div>
            <div><i class="fas fa-clock"></i> ${event.time}</div>
            <div><i class="fas fa-map-marker-alt"></i> ${event.location}</div>
            <div><i class="fas fa-tag"></i> ${event.category}</div>
          </div>
          <div style="margin-top: 0.5rem;">
            <div><i class="fas fa-users"></i> ${event.participants.length}/${event.maxParticipants === 'Unlimited' ? '∞' : event.maxParticipants} participants</div>
            <div><i class="fas fa-dollar-sign"></i> ${event.price}</div>
          </div>
        </div>
      </div>
    `;

    showNotification('Successfully joined the event!', 'success');
    codeInput.value = '';
  }

  // Auto-uppercase event code input
  document.getElementById('eventCodeInput').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
  });

  // Helper function for notifications (fallback if not defined elsewhere)
  function showNotification(message, type = 'info') {
    if (typeof window.showNotification === 'function') {
      window.showNotification(message, type);
      return;
    }
    
    // Simple fallback notification
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
    `;
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    setTimeout(() => {
      notification.style.transform = 'translateX(100%)';
      setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
  }
</script>

<!-- Floating Chatbot Toggle Button -->
<button id="chatbotToggle" class="btn-primary" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
  💬 Ask Routify
</button>

<!-- Chatbot Popup Box -->
<div id="chatbotBox" style="display: none; position: fixed; bottom: 90px; right: 30px; width: 300px; height: 400px; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.2); border-radius: 12px; overflow: hidden; z-index: 999;">
  <div style="background: #4b7bec; color: #fff; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
    <span>Routify Bot</span>
    <button id="closeChatbot" style="background: transparent; color: #fff; border: none; font-size: 16px; cursor: pointer;">✖</button>
  </div>
  <iframe src="chatbot.html" width="100%" height="100%" style="border: none;"></iframe>
</div>

<!-- Script (MUST be after HTML) -->
<script>
  const toggleBtn = document.getElementById("chatbotToggle");
  const chatbotBox = document.getElementById("chatbotBox");
  const closeBtn = document.getElementById("closeChatbot");

  toggleBtn.addEventListener("click", () => {
    chatbotBox.style.display = "block";
  });

  closeBtn.addEventListener("click", () => {
    chatbotBox.style.display = "none";
  });
</script>


</body>
</html>
